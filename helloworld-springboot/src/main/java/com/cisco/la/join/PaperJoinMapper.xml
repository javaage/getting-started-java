<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cisco.la.join.PaperJoinMapper">
  <resultMap id="BaseResultMap" type="com.cisco.la.model.PaperModel">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 14 16:19:03 CST 2018.
    -->
    <id column="ppr_id" jdbcType="INTEGER" property="id" />
    <result column="ppr_quz_id" jdbcType="INTEGER" property="quizID" />
    <result column="ppr_usr_id" jdbcType="VARCHAR" property="userID" />
    <result column="ppr_content" jdbcType="VARCHAR" property="content" />
    <result column="ppr_standard" jdbcType="VARCHAR" property="standard" />
    <result column="ppr_answer" jdbcType="VARCHAR" property="awswer" />
    <result column="ppr_update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="ppr_score" jdbcType="INTEGER" property="score" />
    <result column="ppr_total" jdbcType="INTEGER" property="total" />
    <result column="ppr_index" jdbcType="INTEGER" property="index" />
    <result column="ppr_session" jdbcType="TIMESTAMP" property="session" />
    <result column="ppr_active" jdbcType="BIT" property="active" />
  </resultMap>
  <select id="getWaitingPaper" resultMap="BaseResultMap">
		select p.ppr_id, p.ppr_quz_id, p.ppr_usr_id, p.ppr_content, p.ppr_standard, p.ppr_answer, 
       p.ppr_update_time, p.ppr_score, p.ppr_total, p.ppr_index, p.ppr_session, 
       p.ppr_active from la_paper p
		inner join
		(select ppr_usr_id, max(ppr_session) as ppr_session, min(ppr_id) as ppr_id from la_paper where ppr_active=true and ppr_session &lt; now() - interval '1 day'
		 group by ppr_usr_id) a
		on p.ppr_usr_id = a.ppr_usr_id and p.ppr_session = a.ppr_session and p.ppr_id = a.ppr_id
   </select>
   <update id="inactivePaperByQuizID" parameterType="Integer">
   		UPDATE public.la_paper SET  ppr_active=false WHERE ppr_quz_id = #{quizID}
   </update>
   <select id="getActivePaperByUserID" parameterType="String" resultMap="BaseResultMap">
		select p.ppr_id, p.ppr_quz_id, p.ppr_usr_id, p.ppr_content, p.ppr_standard, p.ppr_answer, 
       p.ppr_update_time, p.ppr_score, p.ppr_total, p.ppr_index, p.ppr_session, 
       p.ppr_active from la_paper p where p.ppr_usr_id = #{userID} and p.ppr_score is null and p.ppr_active = true
       order by p.ppr_session desc limit 1
   </select>
   <select id="getLatestPaperByUserID" parameterType="String" resultMap="BaseResultMap">
		select p.ppr_id, p.ppr_quz_id, p.ppr_usr_id, p.ppr_content, p.ppr_standard, p.ppr_answer, 
       p.ppr_update_time, p.ppr_score, p.ppr_total, p.ppr_index, p.ppr_session, 
       p.ppr_active from la_paper p where p.ppr_usr_id = #{userID} and p.ppr_score is null
       order by p.ppr_session desc limit 1
   </select>
</mapper>